<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FTNQ</title>
    <link rel="stylesheet" type="text/css" href="css/app.css">

    <!-- update the version number as needed -->
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

</head>
<body>

<div class="topbar">
    <h2>FTNQ</h2>
</div>
<div class="wrapper">

    <div id="welcome"><br/></div>
    <br/>

    Create or Join?<br/><br/>
    <button onclick="createRoom();">Create room</button>

    <br/>
    or
    <br/>
    Roomcode:<br/>
    <input type="text" name="roomCode" id="roomCode"/>
    <button onclick="joinRoom();">Join room</button>
    <div id="loading" style="visibility: hidden">Loading...</div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // The Firebase SDK is initialized
            const firestore = firebase.firestore();
            const settings = {timestampsInSnapshots: true};
            firestore.settings(settings);
            //
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    //Logged in
                    console.log(user);
                    //show welcome message
                    firestore
                        .collection('users').doc(user.uid).get()
                        .then(function (doc) {
                            if (doc.exists) {
                                console.log("Document data:", doc.data());
                                document.getElementById('welcome').innerText = "Welcome " + doc.data().nickname;

                                let roomCode = doc.data().roomCode;
                                if (roomCode) {
                                    //already in a room, skip to next screen
                                    window.location = 'room.html';
                                }
                            } else {
                                // doc.data() will be undefined in this case
                                console.log("No such document!");
                                firebase.auth().signOut(); //bye bye
                            }
                        }).catch(function (error) {
                        console.log("Error getting document:", error);
                    });
                } else {
                    //Logged out
                    window.location = '/index.html';
                }
            });
            try {
                let app = firebase.app();
                console.log("Firebase loaded");
            } catch (e) {
                console.error(e);
            }
        });

        //click the ok-button
        function createRoom() {
            //Request new room
            console.log("creating room");
            var createRoom = firebase.functions().httpsCallable('createRoom');
            createRoom().then(function (result) {
                console.log("created roomCode: " + result.data.roomCode);
                window.location = 'room.html';
            });
        }

        function joinRoom() {
            let joinRoom = firebase.functions().httpsCallable('joinRoom');
            let roomCodeToJoin = document.getElementById('roomCode').value.toUpperCase();
            console.log("Trying to join: " + roomCodeToJoin);
            document.getElementById('loading').style.visibility = 'visible';
            joinRoom({roomCode: roomCodeToJoin}).then(function (result) {
                window.location = 'room.html';
            }).catch(function () {
                alert("Roomcode bestaat niet");
                document.getElementById('loading').style.visibility = 'hidden';
            });
        }

    </script>
</div>
</body>
</html>