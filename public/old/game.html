<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>FTNQ</title>
  <link href="css/app.css" rel="stylesheet" type="text/css">

  <!-- update the version number as needed -->
  <!-- include only the Firebase features as you need -->
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
</head>
<body>
<div class="topbar">
  <h2>FTNQ</h2>
</div>
<div class="wrapper">

  <div style="align-content: end"><a href="changeNick.html">Change nickname</a> | <a href="logout.html">Logout</a>
  </div>

  <div id="welcome"><br/></div>

  Loading...

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // The Firebase SDK is initialized
      const firestore = firebase.firestore();
      const settings = {timestampsInSnapshots: true};
      firestore.settings(settings);
      //
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          //Logged in
          console.log(user);
          //check if user is in room
          firestore
            .collection('users').doc(user.uid).get()
            .then(function (userDoc) {
              if (userDoc.exists) {
                console.log("user:", userDoc.data());
                document.getElementById('welcome').innerText = "Welcome " + userDoc.data().nickname;

                let roomCode = userDoc.data().roomCode;
                if (!roomCode) {
                  //not in a room
                  window.location = 'index.html';
                  return;
                }

                firestore
                  .collection('rooms').doc(roomCode)
                  .get().then((roomDoc) => {
                  //check room status
                  if (!roomDoc.exists) {
                    //room does not exist
                    //window.location = 'logout.html';
                    alert('Room does not exist');
                    //going to logout will erase the roomCode from the user
                    return;
                  }

                  let room = roomDoc.data();
                  console.log("room: " + room);
                  if (room.status === 'deleted') {
                    //room deleted
                    //window.location = 'logout.html';
                    alert('room is deleted');
                    //going to logout will erase the roomCode from the user
                    return;
                  }

                  if (room.status === 'waitingForPlayers') {
                    //room not started
                    window.location = 'room.html';
                    return;
                  }

                  if (room.status === 'gameOver') {
                    alert('Game over - Thanks for playing!');
                    window.location = 'logout.html';
                    return;
                  }

                  const regexRound = /^round\d{1,3}$/;
                  let regexMatch;
                  if ((regexMatch = regexRound.exec(room.status)) !== null) {
                    //status is of a round
                    //get round
                    firestore
                      .collection('rooms').doc(roomCode)
                      .collection('rounds').doc(room.status).get()
                      .then((roundDoc) => {
                        if (!roundDoc.exists) {
                          //Bugged room?
                          console.log('round does exist');
                          alert('round does not exist');
                          //window.location = 'room.html';
                        }

                        let round = roundDoc.data();
                        if (round.status === 'writeAnswers') {
                          window.location = 'answerQuestions.html';
                        }
                      });
                  }
                });

              } else {
                //user user not exist
                console.log("User does not exist");
                //window.location = 'logout.html';
                alert('user does not exist!');
              }
            }).catch(function (error) {
            console.log("Error getting document:", error);
            //window.location = 'logout.html';
            alert(error);
          });
        } else {
          //Logged out
          window.location = '/index.html';
        }
      });
      try {
        let app = firebase.app();
        console.log("Firebase loaded");
      } catch (e) {
        console.error(e);
      }
    });
  </script>
</div>
</body>
</html>