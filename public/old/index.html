<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FTNQ</title>
    <link rel="stylesheet" type="text/css" href="css/app.css">

    <script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css"/>

    <!-- update the version number as needed -->
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

</head>
<body>

<div class="topbar">
<h2>FTNQ</h2>
</div>

<div class="wrapper">
<div id="loading">Loading...</div>

<div id="login_stuff" style="visibility: hidden">
    Login anonymously:<br/>
    <button onclick="loginAnon(); return false;">Login anonymously</button>
    <br/><br/>

    Or login with account:
    <br/>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading...</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // The Firebase SDK is initialized

        const firestore = firebase.firestore();
        const settings = {timestampsInSnapshots: true};
        firestore.settings(settings);

        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', {
            callbacks: {
                signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                    // User successfully signed in.
                    // Return type determines whether we continue the redirect automatically
                    // or whether we leave that to developer to handle.
                    return true;
                },
                uiShown: function () {
                    // The widget is rendered.
                    // Hide the loader.
                    document.getElementById('loader').style.display = 'none';
                }
            },
            signInFlow: 'popup',
            signInSuccessUrl: '//frankkienl-tnq.firebaseapp.com/changeNick.html',
            signInOptions: [
                {
                    provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    requireDisplayName: false
                },
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    scopes: ['profile', 'email'],
                    prompt: 'select_account'
                }
            ],
            tosUrl: '//frankkienl-tnq.firebaseapp.com/tos.html'
        });

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                //Logged in
                console.log(user);
                //check if user has an nickname yet
                firestore
                    .collection('users').doc(user.uid).get()
                    .then(function (userDoc) {
                        if (userDoc.exists) {
                            console.log("User document data:", userDoc.data());

                            if (!userDoc.data().nickname) {
                                //logged in
                                //no nickname set
                                window.location = 'changeNick.html';
                            } else if (!userDoc.data().currentRoom) {
                                //logged in
                                //has a nickname
                                //not in a room
                                window.location = 'pickroom.html';
                            } else {
                                //logged in
                                //has a nickname
                                //has a room
                                window.location = 'room.html';
                            }
                        } else {
                            console.log("No user document!");
                            //so no nickname set
                            window.location = 'changeNick.html';
                        }
                    }).catch(function (error) {
                    console.log("Error getting document:", error);
                });
            } else {
                //Logged out
                //Show login options
                document.getElementById('loading').style.visibility = 'hidden';
                document.getElementById('login_stuff').style.visibility = 'visible';
            }
        });
        try {
            let app = firebase.app();
            console.log("Firebase loaded");
        } catch (e) {
            console.error(e);
        }
    });

    //click the ok-button
    function loginAnon() {
        //Login anon
        firebase.auth().signInAnonymously().catch(function (error) {
            console.log(error);
        });
    }
</script>
</div>
</body>
</html>
