<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FTNQ</title>
    <link rel="stylesheet" type="text/css" href="css/app.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- update the version number as needed -->
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
</head>
<body>
<div class="topbar">
    <h2>FTNQ</h2>
</div>
<div class="wrapper">

    <div style="align-content: end"><a href="changeNick.html">Change nickname</a> | <a href="logout.html">Logout</a>

        <div id="roomCode"></div>

        Dat was het einde van de ronde!

        <div id="vipOnly" style="visibility: hidden;">
            <br/><br/><br/>
            <button onclick="vipNextRound()">(VIP) Naar volgende ronde</button>
            <div id="loading" style="visibility: hidden">Loading...</div>
        </div>

        <br/><br/>
        <div id="scores">
            Loading scores...
        </div>

        <br/><br/><br/>
        <a href="game.html">soort van refresh</a>

        <script>

            let user;
            let userUid;
            let currentRoomCode; //code
            let room; //object
            let round;
            let isVip = false;
            let players = [];

            document.addEventListener('DOMContentLoaded', function () {
                // The Firebase SDK is initialized
                const firestore = firebase.firestore();
                const settings = {timestampsInSnapshots: true};
                firestore.settings(settings);
                //
                firebase.auth().onAuthStateChanged(async authUser => {
                    if (authUser) {
                        userUid = authUser.uid;
                        await main();
                    } else {
                        //logged out
                        window.location = 'index.html';
                    }
                });

                try {
                    let app = firebase.app();
                    console.log("Firebase loaded");
                } catch (e) {
                    console.error(e);
                }
            });

            async function main() {
                firestore = firebase.firestore();
                const settings = {timestampsInSnapshots: true};
                firestore.settings(settings);

                let userSnapshot = await firestore.doc(`users/${userUid}`).get();
                user = userSnapshot.data();
                currentRoomCode = user.currentRoom;

                let roomSnapshot = await firestore.doc(`rooms/${currentRoomCode}`).get();
                room = roomSnapshot.data();
                isVip = room.vip === userUid;
                if (isVip) {
                    document.getElementById('vipOnly').style.visibility = 'visible';
                }

                let roundSnapshot = await firestore.doc(`rooms/${room.status}`).get();
                round = roundSnapshot.data();

                document.getElementById('roomCode').innerText = currentRoomCode;

                startListeningForRoundStatus();

                //Score board
                let playersCollection = await firestore.collection(`rooms/${room.status}/players`).get();
                playersCollection.forEach(function(doc){
                    let player = doc.data();
                    players.push(player);
                });
                let htmlScores = '<ul>\n';
                for (let i = 0; i<players.length; i++){
                    let p = players[i];
                    let score = (!p.score) ? '0' : p.score;
                    htmlScores += `<li>${p.nickname} - ${score}</li>`;
                }
                htmlScores += '</ul>';
                document.getElementById('scores').innerHTML = htmlScores;
            }

            function startListeningForRoundStatus() {
                firestore.doc(`rooms/${currentRoomCode}/rounds/${room.status}`)
                    .onSnapshot((roundDoc) => {
                        round = roundDoc.data();
                        if (round.status === 'ended') {
                            //go to next round
                            //room.status should be round2 (or 3) now
                            window.location = 'game.html';
                        }
                    });
            }

            function vipNextRound() {
                console.log('go to next round');
                document.getElementById('loading').style.visibility = 'visible';
                let gotoNextFunc = firebase.functions().httpsCallable('vipGoToNextRound');
                gotoNextFunc({}).then(() => {
                    console.log('going to next round.');
                }).catch((error) => {
                    console.log(error);
                    alert(error);
                });
            }
        </script>
    </div>
</div>
</body>
</html>