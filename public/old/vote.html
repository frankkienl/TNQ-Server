<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FTNQ</title>
    <link rel="stylesheet" type="text/css" href="css/app.css">

    <!-- update the version number as needed -->
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
</head>
<body>
<div class="topbar">
    <h2>FTNQ</h2>
</div>
<div class="wrapper">
    <div id="roomCode"><br/></div>
    <div style="align-content: end"><a href="changeNick.html">Change nickname</a> | <a href="logout.html">Logout</a>
    </div>

    <div id="welcome"><br/></div>

    <div id="clock"><br/></div>

    <div id="loading">Loading...</div>

    <div id="vote"><br/></div>
    <div id="voteResult"><br/></div>

    <div id="vipskip" style="visibility: hidden">
        <button onclick="vipSkip(); return false;">(VIP) Skip, ook al is nog niet iedereen klaar met stemmen
        </button>
    </div>

    <script>
        //
        let userUid;
        let user;
        let roomCode;
        let room;
        let round;
        let questionsPerUser; //object field per user
        let questions = [];
        let answers = [];
        let questionIndex = 0;
        let writeAnswersStartedAt; //when the round started, used when calculating time left.
        let isVip = false;

        document.addEventListener('DOMContentLoaded', function () {
            // The Firebase SDK is initialized
            const firestore = firebase.firestore();
            const settings = {timestampsInSnapshots: true};
            firestore.settings(settings);
            //
            firebase.auth().onAuthStateChanged(async authUser => {
                if (authUser) {
                    userUid = authUser.uid;
                    await main();
                } else {
                    //logged out
                    window.location = 'index.html';
                }
            });

            try {
                let app = firebase.app();
                console.log("Firebase loaded");
            } catch (e) {
                console.error(e);
            }
        });

        async function main() {
            firestore = firebase.firestore();
            const settings = {timestampsInSnapshots: true};
            firestore.settings(settings);

            let userSnapshot = await firestore.doc(`users/${userUid}`).get();
            user = userSnapshot.data();
            roomCode = user.roomCode;
            document.getElementById('roomCode').innerText = roomCode;
            let roomSnapshot = await firestore.doc(`rooms/${roomCode}`).get();
            room = roomSnapshot.data();
            if (room.vip === userUid) {
                isVip = true;
            }
            let roundSnapshot = await firestore.doc(`rooms/${roomCode}/rounds/${room.status}`).get();
            round = roundSnapshot.data();
            questionsPerUser = round.questionsPerUser; //object (map)

            let questionsCollection = await firestore.collection(`rooms/${roomCode}/rounds/${room.status}/questions`).get();
            questionsCollection.forEach((questionSnapshot) => {
                questions.push(questionSnapshot.data());
            });
            let answersCollection = await firestore.collection(`rooms/${roomCode}/rounds/${room.status}/answers`).get();
            answersCollection.forEach((answerSnapshot) => {
                answers[answerSnapshot.id] = answerSnapshot.data();
            });

            //
            startListeningForRoundStatus();
        }

        function showQuestionAndAnswersToVote() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('vote').style.display = 'block';
            document.getElementById('voteResult').style.display = 'none';
            let currentQuestion = questions[questionIndex];
            //console.log(currentQuestion);
            //console.log(answers);

            //debugger;

            let allowedToVote = true;
            let myQuestions = questionsPerUser[userUid];
            //console.log(myQuestions);
            for (let i = 0; i < myQuestions.length; i++) {
                if (myQuestions[i] === 'question' + currentQuestion.id) {
                    allowedToVote = false;
                }
            }

            let leftAnswer = answers[currentQuestion.leftPlayer]['question' + currentQuestion.id];
            let rightAnswer = answers[currentQuestion.rightPlayer]['question' + currentQuestion.id];
            let html = 'Stemmen<br /><table border="1">'
                + '<tr><th colspan="2">'
                + currentQuestion.question.question
                + '</th></tr>';

            if (allowedToVote) {
                html += '<tr>'
                    + `<td><button onclick="voteForAnswer(${currentQuestion.id}, '${currentQuestion.leftPlayer}'); return false;">${leftAnswer}</button></td>`
                    + `<td><button onclick="voteForAnswer(${currentQuestion.id}, '${currentQuestion.rightPlayer}'); return false;">${rightAnswer}</button></td>`
                    + '</tr>';
            } else {
                html += '<tr><td colspan="2"><i>je mag niet stemmen voor deze vraag</i></td></tr>';
                html += '<tr>'
                    + `<td>${leftAnswer}</td>`
                    + `<td>${rightAnswer}</td>`
                    + '</tr>';
            }

            html += '</table>';
            document.getElementById('vote').innerHTML = html;
        }

        async function showQuestionAndVoteResult() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('clock').style.display = 'none';
            document.getElementById('vote').style.display = 'none';
            let currentQuestion = questions[questionIndex];

            let leftAnswer = answers[currentQuestion.leftPlayer]['question' + currentQuestion.id];
            let rightAnswer = answers[currentQuestion.rightPlayer]['question' + currentQuestion.id];
            //let leftName = room.players[currentQuestion.leftPlayer].nickname;
            let leftName = "Linker speler";
            //let rightName = room.players[currentQuestion.rightPlayer].nickname;
            let rightName = "Rechter speler";
            let html = 'Resultaat<br /><table border="1">'
                + '<tr><th colspan="2">'
                + currentQuestion.question.question
                + '</th></tr>';
            html += '<tr>'
                + `<td>${leftAnswer}</td>`
                + `<td>${rightAnswer}</td>`
                + '</tr>';

            //show nr of votes (and who voted)
            html += '<tr>'
                + `<td><span id="leftVotes">?</span></td>`
                + `<td><span id="rightVotes">?</span></td>`
                + '</tr>';

            //Show who submitted that answer
            html += '<tr>'
            + `<td>by: <strong>${leftName}</strong></td>`
            + `<td>by: <strong>${rightName}</strong></td>`
            + '</tr>';

            html += '</table>';

            if (isVip) {
                html += "<br /><button onclick='vipNextVote(); return false;'>Next</button>";
            }
            document.getElementById('voteResult').innerHTML = html;
            document.getElementById('voteResult').style.display = 'block';

            //debugger;
            let voteResultSnapshot = await firestore
                .doc(`rooms/${room.roomCode}/rounds/${room.status}/voteResults/question${currentQuestion.id}`)
                .get();
            let voteResult = voteResultSnapshot.data();
            document.getElementById('leftVotes').innerText = voteResult.leftPoints;
            document.getElementById('rightVotes').innerText = voteResult.rightPoints;
        }


        /**
         * Vote for an answer, of a question
         * @param questionId the question that has been answered
         * @param playerId the answer of which player that has been picked
         */
        function voteForAnswer(questionId, playerId) {
            //answer
            console.log('answering question...');
            document.getElementById('vote').innerHTML = 'Voting...';
            let vote = firebase.functions().httpsCallable('voteForAnswer');
            vote({votedQuestionId: questionId, vote: playerId}).then(() => {
                console.log(`voting done. ${questionId} ${playerId}`);
                document.getElementById('vote').innerHTML = 'Voted. Now wait for other players to vote.';
            }).catch((error) => {
                console.log(error);
                //alert(error); //pretend it didn't happen
            });
        }

        function showDone() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('question').innerText = "Done, now wait for other players";
        }

        function showClock() {
            document.getElementById('clock').style.display = 'block';
            setInterval(updateClock, 500);
        }

        function updateClock() {
            let text = "Time: ";
            let start = votingStartedAt.seconds; //Date.parse(writeAnswersStartedAt);
            let timelimit = 30;
            let diff = (start + timelimit) - Math.floor(Date.now() / 1000);
            if (diff < 0) {
                text = "Time is up!";
                if (isVip) {
                    document.getElementById('vipskip').style.display = 'block';
                }
            } else {
                text += diff;
            }
            document.getElementById('clock').innerText = text;
        }

        function startListeningForRoundStatus() {
            firestore.doc(`rooms/${roomCode}/rounds/${room.status}`)
                .onSnapshot((roundDoc) => {
                    //check if status has changed
                    round = roundDoc.data();
                    console.log("on round status");
                    console.log(roundDoc.data());
                    //
                    if (round.status === 'results') {
                        //go to results
                        window.location = 'roundResult.html';
                    } else if (round.status === 'voteResult') {
                        //show result of latest voting
                        questionIndex = round.votingQuestionIndex;
                        showQuestionAndVoteResult();
                    } else {
                        //go to next question
                        //set question we vote on next
                        questionIndex = round.votingQuestionIndex;
                        showQuestionAndAnswersToVote();
                    }
                });
        }

        function vipSkip() {
            //Skip to voting
            console.log('skipping to voting result...');
            let skipFunc = firebase.functions().httpsCallable('vipEndVoting');
            skipFunc({}).then(() => {
                console.log('skipping to voting result.');
            }).catch((error) => {
                console.log(error);
                alert(error);
            });
        }

        function vipNextVote() {
            //Go to next vote
            console.log('go to next vote, after viewing results');
            let nextVote = firebase.functions().httpsCallable('vipNextVote');
            nextVote({}).then(() => {
                console.log('Going to next vote.');
            }).catch((error) => {
                console.log(error);
                alert(error);
            });
        }

    </script>
</div>
</body>
</html>