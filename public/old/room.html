<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FTNQ</title>
    <link rel="stylesheet" type="text/css" href="css/app.css">

    <!-- update the version number as needed -->
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

</head>
<body>
<div class="topbar">
    <h2>FTNQ</h2>
</div>
<div class="wrapper">

    <div style="align-content: end"><a href="changeNick.html">Change nickname</a> | <a href="logout.html">Logout</a>
    </div>

    <div id="welcome"><br/></div>
    <div id="roomCode"><br/></div>
    <div id="startgame"><br/></div>
    <div id="loading" style="visibility: hidden">Loading...</div>
    <br/>
    Wacht op spelers...
    <div id="players"></div>

    <script>
        let roomCode = "";
        document.addEventListener('DOMContentLoaded', function () {
            // The Firebase SDK is initialized
            const firestore = firebase.firestore();
            const settings = {timestampsInSnapshots: true};
            firestore.settings(settings);
            //
            var playerNicknames = [];
            var isVip = false;
            //
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    //Logged in
                    console.log(user);
                    //show welcome message
                    firestore
                        .collection('users').doc(user.uid).get()
                        .then(function (doc) {
                            if (doc.exists) {
                                console.log("Document data:", doc.data());
                                roomCode = doc.data().roomCode;
                                document.getElementById('welcome').innerText = "Welcome " + doc.data().nickname;
                                document.getElementById('roomCode').innerText = "Roomcode: " + roomCode;

                                //start listening for players
                                firestore
                                    .collection('rooms').doc(roomCode)
                                    .collection('players').onSnapshot(function (snapshot) {
                                    //console.log(snap);
                                    playerNicknames = []; //reset
                                    snapshot.forEach(function (playerDoc) {
                                        if (playerDoc.data().vip === true) {
                                            playerNicknames.push(playerDoc.data().nickname + " (VIP)");
                                        } else {
                                            playerNicknames.push(playerDoc.data().nickname);
                                        }
                                    });
                                    let listOfPlayersHTML = "";
                                    listOfPlayersHTML += '<ul>\n';
                                    for (let i = 0; i < playerNicknames.length; i++) {
                                        listOfPlayersHTML += '<li>' + playerNicknames[i] + '</li>\n';
                                    }
                                    listOfPlayersHTML += '</ul>';
                                    document.getElementById('players').innerHTML = listOfPlayersHTML;

                                    if (isVip && playerNicknames.length >= 3) {
                                        showStartGameButton();
                                    }
                                });

                                //start listening for room status change
                                firestore
                                    .collection('rooms').doc(roomCode).onSnapshot(function (snapshot) {
                                    console.log(snapshot.data());
                                    if (snapshot.data().status !== 'waitingForPlayers') {
                                        window.location = 'game.html'
                                    }
                                    if (snapshot.data().vip === user.uid) {
                                        isVip = true;
                                    }

                                    if (isVip && playerNicknames.length >= 3) {
                                        showStartGameButton();
                                    }
                                });

                            } else {
                                // doc.data() will be undefined in this case
                                console.log("No such document!");
                                firebase.auth().signOut(); //bye bye
                            }
                        }).catch(function (error) {
                        console.log("Error getting document:", error);
                    });
                } else {
                    //Logged out
                    window.location = '/index.html';
                }
            });

            try {
                let app = firebase.app();
                console.log("Firebase loaded");
            } catch (e) {
                console.error(e);
            }

        });

        function showStartGameButton() {
            var html = "<button onclick='startGame();'>Start Game</button>";
            document.getElementById('startgame').innerHTML = html;
        }

        //Start game button click
        function startGame() {
            console.log('Starting game...');
            document.getElementById('loading').style.visibility = 'visible';
            var startGame = firebase.functions().httpsCallable('startGame');
            startGame().then(function (result) {
                console.log("started game");
                window.location = 'game.html';
            }).catch((error) => {
                alert(error);
            });
        }

    </script>
</div>
</body>
</html>